<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FolioPro Generator</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  
  <script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/5/tinymce.min.js" referrerpolicy="origin"></script>
  
  <style>
    body { font-family: 'Inter', sans-serif; background: #f4f8ff; margin: 0 auto; padding: 20px; max-width: 800px; font-size: clamp(1.2rem, 4vw, 1.6rem); line-height: 1.4; }
    textarea { width: 100%; height: 200px; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-family: monospace; }
    
button {
  background: #007bff;
  color: #fff;
  padding: 10px 20px;
  border: none;
  border-radius: 30px;
  cursor: pointer;
  font-size: 1rem;
  transition: background 0.3s ease;
}
button:hover {
  background: #0056b3;
}

.portada {
  width: 100%;
  max-width: 100%;
  height: auto;
  display: block;
  margin: 0 auto 10px;
  border-radius: 8px;
}

.logo {
  width: 18%;
  max-width: 140px;
  min-width: 60px;
  height: auto;
  border-radius: 50%;
  display: block;
  margin: -50px auto 10px;
  border: 4px solid #fff;
  background: #fff;
}

//    .logo { width: 15%; max-width: 120px; min-width: 60px; height: auto; border-radius: 50%; display: block; margin: -50px auto 10px; border: 4px solid #fff; background: #fff; }

    h2, h3, .descripcion, .ubicacion-line, .redes-line { text-align: center; }
    
    h2 { font-size: clamp(1.3rem, 5vw, 1.6rem); color: #4a90e2; margin: 8px 0; }
    h3 { font-size: clamp(1.2rem, 4vw, 1.5rem); color: #555; margin: 6px 0; font-weight: 400; }
    .descripcion { font-size: clamp(1.1rem, 4vw, 1.4rem); color: #333; font-weight: 400; margin: 6px 0; }

    details { margin: 4px 0; border-radius: 6px; overflow: hidden; }
    details summary { background: #007bff; color: #fff; padding: 15px; font-size: clamp(1.2rem, 3.5vw, 1.6rem); cursor: pointer; font-weight: 600; }


.fake-summary {
  background: #643771; /* aseg√∫rate que sea el color por defecto o usa variable JS */
  color: white;
  text-align: left;
  text-transform: uppercase;
  font-weight: 600;
  padding: 15px;
  cursor: pointer;
  font-size: clamp(1.2rem, 3.5vw, 1.6rem); /* exacto al summary */
  border-radius: 6px;
  margin-bottom: 8px;
  list-style: none;
}


details summary {
  background: ${colorBoton};
  color: white;
  text-align: left;
  text-transform: uppercase;
  font-weight: bold;
  padding: 12px 16px;
  cursor: pointer;
  font-size: 16px;
  border: none;
  list-style: none;
  font-family: 'Inter', sans-serif;
  border-radius: 6px;
}

details summary {
  background: ${colorBoton};
  color: white;
  text-align: left; /* üëà Lo cambiamos a left */
  text-transform: uppercase;
  font-weight: bold;
  padding: 12px 16px;
  cursor: pointer;
  font-size: 20px;
  border: none;
  list-style: none;
  font-family: 'Inter', sans-serif;
  border-radius: 6px;
}




    .contenido {
      padding: 15px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
      font-size: clamp(1rem, 3vw, 1.4rem);
      margin-top: 5px;
    }

    p {
      font-size: clamp(1rem, 3vw, 1.4rem);
    }

    
    .contacto, .qr, .firma, .descargar { text-align: center; margin: 20px 0; }
    .redes-line { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
    .redes-line img { width: 48px; height: 48px; border-radius: 50%; cursor: pointer; transition: transform 0.2s; }
    .redes-line img:hover { transform: scale(1.1); }
    pre { background: #eee; padding: 15px; border-radius: 6px; white-space: pre-wrap; font-size: 1rem; display: none; height: auto; max-height: 10em; overflow: auto; }

    .bloque {
  background: white;
  border: 1px solid #ddd; /* Borde sutil visible en fondos blancos */
  border-radius: 12px;
  padding: 16px;
  margin: 12px auto;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05); /* Sombra suave */
  max-width: 95%;
  transition: box-shadow 0.3s ease, border 0.3s ease;
}
.bloque:hover {
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
  border-color: #ccc; /* Sutil cambio al pasar el mouse */
}


details[open] .contenido {
  animation: fadeIn 0.3s ease-in;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-5px); }
  to { opacity: 1; transform: translateY(0); }
}


.galeria {
  display: flex;
  overflow-x: auto;
  scroll-snap-type: x mandatory;
  gap: 12px;
  padding: 10px;
}

.galeria img {
  max-width: 100%;
  height: auto;
  display: block;
  margin: 10px auto;
  border-radius: 10px;
  object-fit: contain;
  scroll-snap-align: center;
}

.galeria iframe {
  flex: 0 0 auto;
  width: 90%;
  max-width: 300px;
  border-radius: 10px;
  scroll-snap-align: center;
}

.galeria::-webkit-scrollbar {
  height: 8px;
}
.galeria::-webkit-scrollbar-thumb {
  background: #ccc;
  border-radius: 4px;
}


.titulo-flotante {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  background: linear-gradient(145deg, #0d6efd, #0a58ca);
  color: white;
  font-family: 'Georgia', serif;
  font-size: clamp(1.2rem, 4vw, 1.4rem);
  font-weight: bold;
  padding: 14px 30px;
  text-align: center;
  z-index: 999;
  border-radius: 0 0 20px 20px; /* redondeado solo abajo */
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
  transition: all 0.3s ease;
}
body {
  padding-top: 80px;
}


  .folio-footer {
  position: fixed;
  top: 60px;
  width: 100%;
  text-align: center;
  font-size: 0.9rem;
  z-index: 998;
}
.folio-footer a {
  color: #001f4d; /* Azul oscuro visible */
  text-decoration: none;
  font-weight: 600;
  font-style: italic;
  transition: color 0.3s;
}
.folio-footer a:hover {
  color: white;
}


.redes-line a img {
  width: 40px;
  height: 40px;
  margin: 5px;
  border-radius: 50%; /* forma circular */
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); /* sombra suave */
  transition: transform 0.2s, box-shadow 0.2s;
  object-fit: cover;
}

.redes-line a img:hover {
  transform: translateY(-3px) scale(1.05); /* efecto al pasar el mouse */
  box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3); /* sombra m√°s intensa al hover */
}


    
  </style>
</head>

<body>
<!-- üü¢ MODAL DE BIENVENIDA -->
  <div id="modalBienvenida" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:99999; display:flex; justify-content:center; align-items:center;">
    <div style="background:#fff; padding:30px; border-radius:12px; text-align:center; max-width:500px; width:90%; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">
      <h2 style="margin-bottom:10px; font-size: 1.8rem; color: #1976d2;">üëã ¬°Bienvenido a FolioPro!</h2>
      <p style="font-size:1.1rem; color:#444;">Tu marca, tu historia, en un solo folio digital. Crea tarjetas profesionales elegantes, personalizadas y listas para compartir.</p>
      <button onclick="cerrarModalBienvenida()" style="margin-top:20px; padding:10px 20px; background:#1976d2; color:white; border:none; border-radius:8px; font-size:1rem; cursor:pointer;">Continuar</button>
    </div>
  </div>

  <!-- üü° USUARIO SUPERIOR DERECHA -->
  <div id="bienvenidaUsuario" style="
    position: absolute;
    top: 10px;
    right: 20px;
    font-weight: bold;
    font-family: 'Inter', sans-serif;
    font-size: 1rem;
    color: #444;
    background: #fff3cd;
    padding: 6px 12px;
    border: 1px solid #ffeeba;
    border-radius: 6px;
    box-shadow: 0 0 4px rgba(0,0,0,0.1);
    display: none;
  ">
    üë§ Bienvenido, <span id="nombreUsuario"></span>
<div id="infoFolios" style="font-size:0.9rem; margin-top:6px;"></div>
  </div>

  <!-- üñºÔ∏è BANNER -->
  <div style="width: 100%; text-align: center; margin: 0; padding: 0;">
    <img src="https://i.ibb.co/XhPvD0q/Banner-Builder.jpg" alt="FolioPro Banner" style="width: 100%; max-width: 100%; height: auto; display: block;">
  </div>

  <!-- üìò TEXTO DE BIENVENIDA -->
  <div style="text-align: center; padding: 30px 20px 40px; background: linear-gradient(to bottom, #f3f6fc, #ffffff); border-radius: 12px; margin-top: 0px; margin-bottom: 30px;">
    <h1 style="font-size: 2.2rem; font-weight: 700; color: #222; margin-top: 10px;">üöÄ Bienvenido a <span style="color: #1976d2;">FolioPro</span></h1>
    <p style="font-size: 1.2rem; color: #333; max-width: 700px; margin: 15px auto;">
      <strong>Tu marca, tu historia, en un solo folio digital.</strong> Crea f√°cilmente tarjetas profesionales para mostrar tus proyectos, productos o servicios.  
      Con FolioPro puedes compartir tu trabajo de forma elegante, moderna y efectiva.
    </p>
    <p style="font-size: 1.05rem; color: #444; margin-top: 20px;">
      ‚úçÔ∏è <strong>Paso 1:</strong> Selecciona tu plantilla FolioPro personalizada <br>
      üõ† <strong>Paso 2:</strong> Da clic en <span style="color: #1976d2; font-weight: bold;">‚ÄúGenerar Tarjeta‚Äù</span> para visualizar y continuar
    </p>
  </div>  
  <div style="text-align: center; margin: 15px 0; font-size: 1rem;">
  <label for="colorBoton">üé® Color de los botones de secci√≥n:</label>
  <input type="color" id="colorBoton" value="#643771" style="margin-right: 20px;">

  <label for="colorFondo">üßæ Color de fondo de la tarjeta:</label>
  <input type="color" id="colorFondo" value="#f4f8ff">
  </div>

  <textarea id="entradaDatos" style="font-size: 1.2rem;" placeholder="#PORTADA:\n...\n#LOGO:\n...\n#TITULO:\n...\n#DESCRIPCION:\n...\n#SECCIONES:\n&&...\n#MAPA:\n...\n#UBICACION:\n...\n#REDES:\n...\n#LINK_QR:\n..."></textarea>
  
<div style="margin: 12px 0;">
  <label for="archivoTxt" style="font-weight:bold;">üìÇ Cargar archivo .txt</label><br>
  <input type="file" id="archivoTxt" accept=".txt">
</div>

  <button id="btnGenerar" onclick="generarTarjeta()">üé® Generar Tarjeta</button>
  <button id="btnBorrarGitHub" onclick="mostrarOpcionesBorrado()">üóë Borrar FolioPro</button>
  <button id="btnConsultarFolios" onclick="consultarFolios()">üîç Consultar FolioPros</button>
  <button id="btnCerrarSesion" onclick="cerrarSesion()">üö™ Cerrar Sesi√≥n</button>


  <div id="vistaPrevia" style="margin-top:20px;"></div>
  <pre id="codigoGenerado" style="margin-top:20px;"></pre>

<button id="btnCopiar" style="display:none;" onclick="copiarHTML()">üìã Copiar C√≥digo HTML</button>
<button onclick="descargarArchivoHTML()" style="display:none;">üíæ Descargar archivo HTML</button>
<button id="btnSubirGitHub" style="display:none;" onclick="subirAGitHub()">üöÄ Subir a GitHub</button>
<button id="btnReemplazarGitHub" style="display:none;" onclick="mostrarOpcionesReemplazo()">üõ† Reemplazar FolioPro</button>
<button id="btnNuevaTarjeta" style="display:none;" onclick="nuevaTarjeta()">üÜï Nueva Tarjeta</button>


  <script>


function aplicarFormato(texto, colorBoton) {

  // Bot√≥n de submen√∫s tipo {goto}: nombre
  texto = texto.replace(/{goto}:\s*(\w[\w\-]*)/g, (match, nombre) => {
    const visible = nombre.replace(/[-_]/g, ' ').toUpperCase();
    return `<button onclick="abrirSubmenu('${nombre}')" style="margin:10px auto; display:block; padding:10px 16px; background:${colorBoton}; color:white; border:none; border-radius:8px; font-weight:bold;">üìÇ ${visible}</button>`;
  });

  // Negrilla alineada a la izquierda
  texto = texto.replace(/\*\*\*(.*?)\*\*\*/g, '<p style="text-align:left;font-weight:bold;">$1</p>');

  // Cursiva
  texto = texto.replace(/\*\*(.*?)\*\*/g, '<span style="font-style:italic;">$1</span>');

  // Subt√≠tulo violeta
  texto = texto.replace(/^###\s*(.*)$/gm, '<p style="text-align:left;color:rgb(100,55,113);font-size:1.1rem;font-weight:bold;margin-top:12px;">$1</p>');

  // Texto centrado
  texto = texto.replace(/@@(.*?)@@/g, '<p style="text-align:center;">$1</p>');

  // Vi√±etas
  texto = texto.replace(/((?:^&- .*(?:\n|$))+)/gm, match => {
    const items = match.trim().split('\n').map(line => {
      return `<li>${line.replace(/^&- /, '').trim()}</li>`;
    }).join('');
    return `<ul>${items}</ul>`;
  });

  // Listas numeradas
  texto = texto.replace(/((?:^&: .*(?:\n|$))+)/gm, match => {
    const items = match.trim().split('\n').map(line => {
      return `<li>${line.replace(/^&: /, '').trim()}</li>`;
    }).join('');
    return `<ol>${items}</ol>`;
  });

  // üìå Enlaces tipo bot√≥n externo (abre en otra pesta√±a)
  texto = texto.replace(/@url:\s*"(.*?)";\s*(https?:\/\/[^\s]+)/g,
    `<div style="width:100%;text-align:center;margin:12px 0;">
      <a href="$2" target="_blank" style="
        display:inline-block;
        width:80%;
        max-width:600px;
        background:${colorBoton};
        color:white;
        padding:14px 20px;
        border-radius:10px;
        text-align:center;
        font-weight:bold;
        font-size:1.1rem;
        text-decoration:none;
        box-shadow:0 4px 8px rgba(0,0,0,0.1);
        transition:all 0.3s ease;
      ">$1</a>
    </div>`);

  // üìå Nuevo: Botones que abren documentos en ventana modal
texto = texto.replace(/@urld:\s*"([^"]+)"\s*;\s*(https?:\/\/[^\s]+)/g, (match, titulo, url) => {
  return `
    <div style="text-align:center; margin:10px 0;">
      <button onclick="abrirEnlaceExternoModal('${url}')" style="
        width: 90%;
        max-width: 400px;
        padding: 14px 16px;
        background: ${colorBoton};
        color: white;
        border: none;
        border-radius: 10px;
        font-weight: bold;
        font-size: 1.1rem;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        cursor: pointer;
      ">üìÑ ${titulo}</button>
    </div>`;
});

  return texto;
}



function generarTarjeta() {
      const texto = document.getElementById('entradaDatos').value || '';
      if (!texto.trim()) return alert('Por favor, pega el contenido.');

      const datos = {};

let colorBoton = '#643771';
let colorFondo = '#f4f8ff';
let fondoLogo = '';

const lineas = texto.split('\n');
let claveActual = '';
datos['RAW'] = {};

for (let linea of lineas) {
  const match = linea.match(/^#(\w+):\s*(.*)$/);
  if (match) {
    claveActual = match[1];
    const contenido = match[2].trim();
    datos[claveActual] = contenido !== '' ? contenido : '';
  } else if (claveActual) {
    if (datos[claveActual]) {
      datos[claveActual] += '\n' + linea.trim();
    } else {
      datos[claveActual] = linea.trim();
    }
  }
}


// ‚úÖ LUEGO: Parsear la fecha de vencimiento desde datos.VENCIMIENTO
let fechaVencimiento = null;
if (datos.VENCIMIENTO) {
  const raw = datos.VENCIMIENTO.split('\n').map(l => l.trim()).filter(l => l)[0]; // solo primera l√≠nea v√°lida
  const partes = raw?.split('/');
  if (partes && partes.length === 3) {
    const [dd, mm, yyyy] = partes;
    fechaVencimiento = new Date(`${yyyy}-${mm}-${dd}T23:59:59`);
    console.log("‚úÖ Fecha de vencimiento interpretada como:", fechaVencimiento.toISOString());
  } else {
    console.warn("‚ö†Ô∏è Formato de fecha inv√°lido en #VENCIMIENTO:", datos.VENCIMIENTO);
  }
}




// Leer colores personalizados desde #COLORES

let usarPaleta = false; // por defecto no usamos paleta

if (datos.COLORES) {
  const lineasColor = datos.COLORES.split('\n');
  for (let l of lineasColor) {
    const [clave, ...resto] = l.split(':');
    const valor = resto.join(':').trim();

    if (clave.includes('&paleta') && valor.toLowerCase() === 's') {
      usarPaleta = true;
    }

    if (!usarPaleta && clave.includes('&boton') && /^\s*\d{1,3}\s*,\s*\d{1,3}\s*,\s*\d{1,3}\s*$/.test(valor)) {
      colorBoton = `rgb(${valor.replace(/\s+/g, '')})`;
    }

    if (!usarPaleta && clave.includes('&fondo') && /^\s*\d{1,3}\s*,\s*\d{1,3}\s*,\s*\d{1,3}\s*$/.test(valor)) {
      colorFondo = `rgb(${valor.replace(/\s+/g, '')})`;
    }

    if (clave.includes('&fondologo') && valor.startsWith('http')) {
      fondoLogo = valor;
    }
  }
}

// ‚úÖ Si se activa la paleta visual, usamos sus valores
if (usarPaleta) {
  colorBoton = document.querySelector('#colorBoton').value || colorBoton;
  colorFondo = document.querySelector('#colorFondo').value || colorFondo;
}

      

// Procesar BOTONFLOT
let botonW = '', botonC = '', botonM = '', botonS = '', botonSM = '';

if (datos.BOTONFLOT) {
  const lineasBoton = datos.BOTONFLOT.split('\n');
  for (let l of lineasBoton) {
    if (l.includes('&%w:')) botonW = l.split(':')[1].trim();
    if (l.includes('&%c:')) botonC = l.split(':')[1].trim();
    if (l.includes('&&m:')) botonM = l.match(/"([^"]+)"/)?.[1] || '';
    if (l.includes('&%s:')) botonS = l.match(/"([^"]+)"/)?.[1] || '';
    if (l.includes('&&s:')) botonSM = l.match(/"([^"]+)"/)?.[1] || '';
  }
}
// Cierre BOTONFLOT




      let bodyHTML = '';


// ‚è≥ Mostrar FV en esquina superior izquierda
let fechaVenc = '31/12/2030'; // valor por defecto

if (datos.VENCIMIENTO && datos.VENCIMIENTO.trim() !== '') {
  fechaVenc = datos.VENCIMIENTO.replace(/-/g, '/');
} else {
  datos.VENCIMIENTO = fechaVenc; // tambi√©n lo guardamos en datos para otras validaciones
}

// no imprimir fecha
//bodyHTML += `
//  <div style="position:fixed; top:10px; left:10px; background:#fce4ec; color:#c2185b; padding:5px 10px; font-weight:bold; font-family:'Inter', sans-serif; border-radius:6px; font-size:0.9rem; z-index:9999;">
//    üìÖ FV: ${fechaVenc}
//  </div>
//`;





      bodyHTML += `
  <div style="text-align:center; font-size:0.9rem; background:#e0f0ff; padding:8px 12px; border-radius:8px; margin-bottom:12px;">
    <a href="https://wa.me/573117715353" target="_blank" style="color:#007bff; text-decoration:none; font-weight:500;">
      üöÄ FolioPro ‚Äì Tu marca y tu historia en un Portafolio Digital
    </a>
  </div>
`;

    
      if (datos.PORTADA) bodyHTML += `<img class="portada" src="${datos.PORTADA}" alt="Portada">`;
      if (datos.LOGO) bodyHTML += `<img class="logo" src="${datos.LOGO}" alt="Logo">`;
      if (datos.TITULO) bodyHTML += `<div class="titulo-flotante">${datos.TITULO}</div>`;
      bodyHTML += `<div class="folio-footer">
      <a href="https://wa.me/573117715353" target="_blank" title="Escr√≠benos a FolioPro">
        üöÄ By FolioPro
      </a>
      </div>`;

      bodyHTML += `<div class="bloque"><h2>${datos.TITULO}</h2></div>`;
      
      if (datos.DESCRIPCION) bodyHTML += `<div class="bloque"><p class='descripcion' style="font-weight:600; text-align:center;">${datos.DESCRIPCION}</p></div>`;
      if (datos.QUIENES_SOMOS) bodyHTML += `<div class="bloque"><p style="text-align:center;">${datos.QUIENES_SOMOS}</p></div>`;



if (datos.SECCIONES) {
  datos.SECCIONES.split(/^&&\s*/m).filter(s => s.trim()).forEach(s => {
    const lineas = s.trim().split('\n');
    const titulo = lineas[0]?.trim() || '';
    const cuerpo = lineas.slice(1).map(l => l.trim()).filter(Boolean);

    // üí° Si solo hay un {goto}, tratamos esta secci√≥n como men√∫ externo
    const esMenu = cuerpo.length === 1 && /{goto}:\s*(\w[\w\-]*)/.test(cuerpo[0]);

    if (esMenu) {
      const idMenu = cuerpo[0].match(/{goto}:\s*(\w[\w\-]*)/)?.[1];

bodyHTML += `
  <div class="fake-summary" onclick="abrirSubmenu('${idMenu}')">
    ‚ñ∂ ${titulo.toUpperCase()}
  </div>
`;

    } else {
      // Secci√≥n normal con contenido enriquecido
      const contenido = cuerpo.map(line => {
        if (/https?:\/\/.+\.(jpg|jpeg|png|gif)/i.test(line)) {
          return `<img src="${line}" style="width:90%;display:block;margin:10px auto;">`;
        } else if (/https?:\/\/(www\.)?(youtube\.com|youtu\.be)/i.test(line)) {
          const videoId = line.split('v=')[1]?.split('&')[0] || line.split('/').pop();
          return `<iframe width="90%" height="315" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen style="display:block;margin:10px auto;"></iframe>`;
        }

        return `<p>${aplicarFormato(line, colorBoton)}</p>`;

      }).join('');

      bodyHTML += `<details><summary>${titulo.toUpperCase()}</summary><div class="contenido">${contenido}</div></details>`;
    }
  });
}


document.querySelectorAll('details').forEach(d => {
    d.addEventListener('toggle', function () {
      if (this.open && scrollHabilitado) {
        document.querySelectorAll('details').forEach(o => {
          if (o !== this) o.removeAttribute('open');
        });
        setTimeout(() => {
          this.scrollIntoView({ behavior: "smooth", block: "start" });
        }, 100);
      }
    });
  });

// Mostrar el contenido generado en la vista previa
  document.getElementById('vistaPrevia').innerHTML = bodyHTML;

  // Asegurar que la p√°gina siempre cargue desde el principio
  window.scrollTo(0, 0);  // Esto har√° que la p√°gina inicie desde la parte superior (inicio)


if (datos.IMAGENES) {
  const lineas = datos.IMAGENES.split('\n').map(l => l.trim()).filter(l => l);
  const galeriaImgs = [];

  for (let i = 0; i < lineas.length; i++) {
    const linea = lineas[i];
    const esURL = /^https?:\/\/.+\.(jpg|jpeg|png|gif)$/i.test(linea);

    if (esURL) {
      const descripcion = lineas[i + 1] && !/^https?:\/\//.test(lineas[i + 1])
        ? encodeURIComponent(lineas[i + 1])
        : '';
      
      galeriaImgs.push(descripcion
        ? `<img src="${linea}" alt="Imagen" style="cursor:pointer;" onclick="mostrarDescripcion('${descripcion}')">`
        : `<img src="${linea}" alt="Imagen">`);
    }
  }

  if (galeriaImgs.length > 0) {
    bodyHTML += `
      <div class="bloque">
        <h3 style="text-align:center;">üì∑ Galer√≠a de Im√°genes</h3>
        <p style="text-align:center;">Haz clic en una imagen para ver la descripci√≥n</p>
        <div class="galeria">${galeriaImgs.join('')}</div>
      </div>`;
  }
}


// Galer√≠a de Videos
if (datos.VIDEOS) {
  const videos = datos.VIDEOS.split('\n').filter(line => line.trim());
  if (videos.length > 0) {
    const galeriaVids = videos.map(url => {
      const videoId = url.includes('youtu')
        ? (url.split('v=')[1]?.split('&')[0] || url.split('/').pop())
        : null;
      return videoId ? `<iframe width="300" height="180" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe>` : '';
    }).join('');
    bodyHTML += `
      <div class="bloque">
        <h3 style="text-align:center;">üé• Galer√≠a de Videos</h3>
        <p style="text-align:center;">Desliza a la derecha o izquierda para ver todos los videos</p>
        <div class="galeria">${galeriaVids}</div>
      </div>`;
  } else {
    bodyHTML += `
      <div class="bloque">
        <h3 style="text-align:center;">üé• Galer√≠a de Videos</h3>
        <p style="text-align:center;">No hay videos disponibles.</p>
      </div>`;
  }
}

      
      if (datos.MAPA) {
        bodyHTML += `
          <div class="bloque">
            <div class="mapa" style="text-align:center;">
              <iframe src="${datos.MAPA}" width="100%" height="300" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
            </div>
          </div>`;
      }
      
if (datos.UBICACION) {
  bodyHTML += `<div class="bloque"><div class="contacto ubicacion-line">`;

  datos.UBICACION.split('\n').forEach(line => {
    line = line.trim();
    if (!line) return;

    const emailMatch = line.match(/([\w.-]+@[\w.-]+\.\w+)/);
    const phoneMatch = line.match(/(\+?\d[\d\s\-()]{7,})/);

    if (emailMatch) {
      const email = emailMatch[1];
      bodyHTML += `<div><a href="mailto:${email}" style="color:#007bff;text-decoration:underline;">${line}</a></div>`;
    } else if (phoneMatch) {
      const numero = phoneMatch[1].replace(/[^\d+]/g, '');
      bodyHTML += `<div><a href="tel:${numero}" style="color:#007bff;text-decoration:underline;">${line}</a></div>`;
    } else {
      bodyHTML += `<div>${line}</div>`;
    }
  });

  bodyHTML += `</div></div>`;
}


  if (datos.REDES) {
    const iconos = {
      facebook: "https://i.ibb.co/6JJ5FZ1S/IFbook.png",
      instagram: "https://i.ibb.co/chCqtLkw/IInstagram.png",
      youtube: "https://i.ibb.co/VYxJpn7X/IYoutube.png",
      whatsapp: "https://i.ibb.co/bgnHxP1y/IWapp.png",
      twitter: "https://i.ibb.co/FqfRcjkg/ITwitter.png",
      linkedin: "https://i.ibb.co/G33VkpGb/ILinkedin.png",
      tiktok: "https://i.ibb.co/nsy5C1y9/ITiktok.png"
    };

    const redesArray = datos.REDES.split('\n').map(line => line.trim()).filter(line => line !== '');
    const redesHTML = [];

    for (let i = 0; i < redesArray.length - 1; i++) {
      const nombre = redesArray[i].replace(':', '').toLowerCase();
      const valor = redesArray[i + 1];
      if (iconos[nombre] && valor) {
        let url = valor;
        if (nombre === 'whatsapp' && !valor.startsWith('http')) {
          url = `https://wa.me/${valor}`;
        }
        redesHTML.push(`<a href="${url}" target="_blank"><img src="${iconos[nombre]}" alt="${nombre}" title="${nombre.charAt(0).toUpperCase() + nombre.slice(1)}"></a>`);
        i++; // Saltamos la siguiente l√≠nea que ya fue usada
      }
    }

    if (redesHTML.length > 0) {
      bodyHTML += `<div class="redes-line">${redesHTML.join('')}</div>`;
    }
  }


if (datos.LINK_QR) {
  const link = datos.LINK_QR.trim();
  const mensajeQR = datos.MENSAJE_QR || 'Escanea para acceder';

  bodyHTML += `
    <div class="bloque" style="text-align:center;">
      <div class="qr">
        <h3 style="font-weight: 500; margin-bottom: 10px;">${mensajeQR}</h3>
        <div style="display:inline-block; position:relative;">
          <img src="https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${encodeURIComponent(link)}" 
               id="codigoQRGenerado" 
               alt="C√≥digo QR" 
               style="width: 180px; height: 180px; border-radius: 12px;">
          <img src="https://i.ibb.co/hFB5PxDS/Logo-cuadrado.png" 
               alt="Logo" 
               style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:40px; height:40px; border-radius:8px; background:white;">
        </div>
        <div>
          <button onclick="descargarQR()" style="margin-top: 6px; font-size: 0.8rem; color: #555; background: none; border: none; cursor: pointer;">‚¨áÔ∏è Descargar QR</button>
        </div>
      </div>
    </div>
  `;
}





      bodyHTML += `<div class="descargar">
        <button onclick="descargarVCF()">üì• Descargar Contacto</button>
      </div>`;
      bodyHTML += `<div class="firma"><p>Desarrollado por <a href='https://wa.me/573117715353'>SupensionPlus</a></p></div>`;

// ‚úÖ Agregar bot√≥n flotante solo con √≠conos personalizados
if (botonW && botonC && botonM) {
  const mensajeFinal = botonS && botonSM ? encodeURIComponent(`${botonSM} ${botonS}`) : '';

  const botonHTML = `
    <div id="botonFlotante" style="position:fixed; bottom:20px; right:20px; display:flex; flex-direction:column; gap:10px; z-index:9999;">
      ${botonS && botonSM ? `
      <a href="https://wa.me/?text=${mensajeFinal}" target="_blank" style="display:inline-block; width:60px; height:60px;">
        <img src="https://i.ibb.co/Dg8NNkgz/image.png" alt="Compartir" style="width:100%; height:100%; object-fit:cover; border-radius:50%; box-shadow:0 2px 8px rgba(0,0,0,0.2);">
      </a>` : ''}

      <a href="https://wa.me/${botonW}?text=${encodeURIComponent(botonM)}" target="_blank" style="display:inline-block; width:60px; height:60px;">
        <img src="https://i.ibb.co/mCdSYYw2/image.png" alt="WhatsApp" style="width:100%; height:100%; object-fit:cover; border-radius:50%; box-shadow:0 2px 8px rgba(0,0,0,0.2);">
      </a>

      <a href="tel:${botonC}" style="display:inline-block; width:60px; height:60px;">
        <img src="https://i.ibb.co/M5pc1WwG/image.png" alt="Llamar" style="width:100%; height:100%; object-fit:cover; border-radius:50%; box-shadow:0 2px 8px rgba(0,0,0,0.2);">
      </a>
    </div>
  `;

  // Mostrar en preview
  document.body.insertAdjacentHTML('beforeend', botonHTML);

  // Incluir en HTML final
  bodyHTML += botonHTML;
}





// üü° SI LA TARJETA EST√Å VENCIDA, MOSTRAR MODAL DE ADVERTENCIA (SOLO EN PREVIEW)
if (fechaVencimiento && Date.now() > fechaVencimiento.getTime()) {
  const modalVencida = `
    <div id="modalVencida" style="
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 99999;
    ">
      <div style="background: #fff; padding: 30px; border-radius: 12px; text-align: center; max-width: 500px; width: 90%; position:relative;">
        <span onclick="document.getElementById('modalVencida').style.display='none'" style="position: absolute; top: 10px; right: 20px; cursor: pointer; font-size: 1.5rem;">‚ùå</span>
        <h2 style="color: #c62828;">‚õî Tarjeta vencida</h2>
        <p>Esta tarjeta ha vencido. Si eres el creador, contacta con soporte para renovarla.</p>
        <a href="https://wa.me/573117715353?text=Hola,%20mi%20tarjeta%20${(localStorage.getItem('nombreTarjeta') || 'mi-tarjeta')}.html%20est√°%20vencida.%20Quiero%20renovar%20la%20licencia.%20Mi%20nombre%20es..." 
           target="_blank" 
           style="display:inline-block; margin-top:10px; padding:10px 20px; background:#25d366; color:white; border-radius:8px; text-decoration:none;">
          üì± Contactar por WhatsApp
        </a>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', modalVencida);
}


// üîê BLOQUEO POR CONTRASE√ëA (solo en preview)
if (datos.PASSWORD && datos.PASSWORD.trim() !== '') {
 console.log("üîê Clave definida:", datos.PASSWORD.trim()); // üëà AQU√ç


  const clave = datos.PASSWORD.trim();
  const promptClave = prompt("üîí Esta tarjeta est√° protegida.\nIngresa la contrase√±a para continuar:");

  if (promptClave !== clave) {
    alert("‚ùå Contrase√±a incorrecta. No se puede mostrar esta tarjeta.");
    return; // Detener ejecuci√≥n si est√° mal
  }
}

// Mostrar el contenido generado en la vista previa
document.getElementById('vistaPrevia').innerHTML = bodyHTML;

// Asegurar que la p√°gina siempre cargue desde la parte superior
  window.scrollTo(0, 0);  // Esto desplazar√° la p√°gina al inicio (parte superior)



if (fondoLogo && fondoLogo.trim() !== '') {
  document.body.style.background = `url(${fondoLogo}) center/cover no-repeat fixed`;
} else {
  document.body.style.background = colorFondo;
}






      document.querySelectorAll('details summary').forEach(s => {
      s.style.background = colorBoton;
      });


const tituloFlotante = document.querySelector('.titulo-flotante');
if (tituloFlotante) {
  tituloFlotante.style.background = colorBoton;
}





	document.querySelectorAll('h2').forEach(h => {
  	h.style.color = colorBoton;
	});


// *** NUEVA L√çNEA PARA ABRIR LA PRIMERA SECCI√ìN ***. ahora no. despues
//document.querySelector('#vistaPrevia details').open = true;

// ‚úÖ Variables din√°micas para el HTML final
const vencimientoISO = fechaVencimiento ? fechaVencimiento.toISOString() : '';
const nombreTarjeta = localStorage.getItem('nombreTarjeta') || 'mi-tarjeta';
const claveTarjeta = datos.PASSWORD ? datos.PASSWORD.trim() : '';



// ‚úÖ AQUI INICIA FULLHTML


const fullHTML = `<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FolioPro - Mi Portafolio Digital</title>

${datos.VENCIMIENTO ? `
  <div style="position: absolute; top: 8px; left: 8px; background: rgba(255,255,255,0.8); padding: 6px 10px; border-radius: 6px; font-size: 0.85rem; font-weight: bold; color: #333; font-family: 'Inter', sans-serif;">
    FV: ${datos.VENCIMIENTO}
  </div>
` : ''}


<meta property="og:title" content="${datos.TITULO || 'Mi Portafolio Digital'}">
<meta property="og:description" content="${datos.DESCRIPCION || 'Conoce mi perfil profesional con FolioPro'}">
<meta property="og:image" content="${datos.LOGO || datos.PORTADA || 'https://foliopro.github.io/default-i|mage.jpg'}">
<meta property="og:url" content="https://foliopro.github.io/ecard/ejemplo.html">
<meta property="og:type" content="website">
  <link href='https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap' rel='stylesheet'>







  <style>

    ${document.querySelector('style').textContent}
document.getElementById
.titulo-flotante {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  background: ${colorBoton}; /* ‚Üê Ahora toma el color del usuario */
  color: white;
  font-family: 'Georgia', serif;
  font-size: clamp(1.2rem, 4vw, 1.4rem);
  font-weight: bold;
  padding: 14px 30px;
  text-align: center;
  z-index: 999;
  border-radius: 0 0 20px 20px;
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
  transition: all 0.3s ease;
}

body {
  padding-top: 80px;
}





    body {
  ${(fondoLogo && fondoLogo.trim() !== '') 
    ? `background: url(${fondoLogo}) center/cover no-repeat fixed;`
    : `background: ${colorFondo};`}
}


details {
  margin-bottom: 8px;
  border-radius: 4px;
  overflow: hidden;
}

details summary {
  background: ${colorBoton};
  color: white;
  text-align: left; /* üëà Lo cambiamos a left */
  text-transform: uppercase;
  font-weight: bold;
  padding: 12px 16px;
  cursor: pointer;
  font-size: 20px;
  border: none;
  list-style: none;
  font-family: 'Inter', sans-serif;
  border-radius: 6px;
}


details summary:hover {
  filter: brightness(1.15);
}

details[open] summary {
  filter: brightness(0.9); /* Oscurece ligeramente al estar abierto */
}

details summary::-webkit-details-marker {
  display: none;
}


  </style>
</head>
<body>

<!-- ‚úÖ FECHA DE VENCIMIENTO -->
  <div style="position: absolute; top: 8px; left: 8px; background: rgba(255,255,255,0.8); padding: 6px 10px; border-radius: 6px; font-size: 0.85rem; font-weight: bold; color: #333; font-family: 'Inter', sans-serif;">
    FV: ${datos.VENCIMIENTO || '31/12/2030'}
  </div>



  ${bodyHTML}

  <div class="modal" id="modalImagen" onclick="cerrarDescripcion()" style="display:none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); z-index: 9999;">
    <div class="modal-contenido" onclick="event.stopPropagation()" style="background:#fff; margin:10% auto; padding:20px; border-radius:10px; max-width:400px; position:relative; text-align:center;">
      <span class="cerrar" onclick="cerrarDescripcion()" style="position:absolute; top:10px; right:20px; cursor:pointer; font-size:1.5rem;">‚ùå</span>
      <div id="descripcionImagen" style="margin-top:20px; font-size:1.1rem;"></div>
    </div>
  </div>


<!-- Modal para documentos externos -->
<div class="modal" id="modalDocumento" onclick="cerrarEnlaceExternoModal()" style="display:none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); z-index: 9999;">
  <div class="modal-contenido" onclick="event.stopPropagation()" style="background:#fff; margin:5% auto; padding:20px; border-radius:10px; width:90%; height:90%; max-width:900px; position:relative;">
    <span class="cerrar" onclick="cerrarEnlaceExternoModal()" style="position:absolute; top:10px; right:20px; cursor:pointer; font-size:1.5rem;">‚ùå</span>
    <iframe id="iframeDocumento" src="" style="width:100%; height:100%; border:none;"></iframe>
  </div>
</div>



  <script>
    // Abre la primera secci√≥n autom√°ticamente
    // document.querySelector('details')?.setAttribute("open", "true");

const secciones = document.querySelectorAll('details');
secciones.forEach(d => {
  d.removeAttribute('open');

  d.addEventListener('toggle', function () {
    if (this.open) {
      secciones.forEach(o => { if (o !== this) o.removeAttribute('open'); });
      setTimeout(() => {
        this.scrollIntoView({ behavior: "smooth", block: "start" });
      }, 100);
    }
  });
});

    

// üîí BLOQUEO SI LA TARJETA YA EST√Å VENCIDA
  const fechaVenc = new Date("${vencimientoISO}");
  if (Date.now() > fechaVenc.getTime()) {
    document.body.innerHTML = '<div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; background:#fefefe; text-align:center; padding:20px;">' +
      '<h2 style="color:#c62828; font-size:1.6rem;">‚õî Esta tarjeta ha vencido</h2>' +
      '<p style="margin-top:10px;">Si eres el creador, contacta con soporte para renovarla.</p>' +
      '<a href="https://wa.me/573117715353?text=Hola,%20mi%20tarjeta%20' + "${nombreTarjeta}" + '.html%20est√°%20vencida.%20Quiero%20renovar%20la%20licencia.%20Mi%20nombre%20es..."' +
      ' target="_blank" style="margin-top:20px; padding:12px 20px; background:#25d366; color:white; border:none; border-radius:8px; text-decoration:none; font-size:1.1rem;">' +
      'üì± Contactar por WhatsApp' +
      '</a>' +
    '</div>';
  }


// üîê BLOQUEO POR CONTRASE√ëA (en fullHTML)
console.log("üß™ El script de contrase√±a se est√° ejecutando...");
  const clave = "${claveTarjeta}";
  if (clave !== "") {
    const mensaje = "üîí Esta tarjeta est√° protegida.\\nIngresa la contrase√±a para continuar:";
    const claveIngresada = prompt(mensaje);
    if (claveIngresada !== clave) {
      document.body.innerHTML = '<div style="text-align:center; padding:40px;"><h2>‚ùå Contrase√±a incorrecta</h2><p>No tienes acceso a esta tarjeta.</p></div>';
    }
  }

    function mostrarDescripcion(texto) {
      const modal = document.getElementById('modalImagen');
      const descBox = document.getElementById('descripcionImagen');
      descBox.innerHTML = decodeURIComponent(texto);
      modal.style.display = 'block';
    }

    function cerrarDescripcion() {
      document.getElementById('modalImagen').style.display = 'none';
    }




// üëá Funci√≥n para abrir documentos externos en modal
function abrirDocumentoModal(url) {
  const modal = document.getElementById('modalDocumento');
  const iframe = document.getElementById('iframeDocumento');
  iframe.src = url;
  modal.style.display = 'block';
}
function cerrarDocumentoModal() {
  const modal = document.getElementById('modalDocumento');
  const iframe = document.getElementById('iframeDocumento');
  iframe.src = '';
  modal.style.display = 'none';
}




    function descargarVCF() {
      const nombre = document.querySelector('h2')?.textContent || 'Contacto';
      const descripcion = document.querySelector('.descripcion')?.textContent || '';
      const telMatch = document.querySelector('.ubicacion-line')?.textContent.match(/\\+?\\d{7,}/);
      const tel = telMatch ? telMatch[0] : '';
      const emailMatch = document.querySelector('.ubicacion-line')?.textContent.match(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}/);
      const email = emailMatch ? emailMatch[0] : '';

      const vcf = \`BEGIN:VCARD
VERSION:3.0
FN:\${nombre}
ORG:\${descripcion}
TEL:\${tel}
EMAIL:\${email}
END:VCARD\`;

      const blob = new Blob([vcf], { type: 'text/vcard' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'contacto.vcf';
      link.click();
    }

    // Exclusividad de secciones tipo details

    let scrollHabilitado = true;














// Funciones para abrir y cerrar documentos externos en modal
function abrirEnlaceExternoModal(url) {
  try {
    const iframe = document.getElementById('iframeDocumento');
    const modal = document.getElementById('modalDocumento');

    iframe.src = url;
    modal.style.display = 'block';

    setTimeout(() => {
      if (!iframe.contentWindow || iframe.contentDocument.body.innerHTML.trim() === '') {
        window.open(url, '_blank');
        cerrarEnlaceExternoModal();
      }
    }, 3000);
  } catch (e) {
    window.open(url, '_blank');
  }
}

function cerrarEnlaceExternoModal() {
  const modal = document.getElementById('modalDocumento');
  const iframe = document.getElementById('iframeDocumento');
  iframe.src = '';
  modal.style.display = 'none';
}


  <\/script>
</body>
</html>`;



      const pre = document.getElementById('codigoGenerado');

	pre.textContent = fullHTML;
	pre.style.display = 'block';

	// Mostrar bot√≥n de copiar
	document.getElementById('btnCopiar').style.display = 'inline-block';

	// Mostrar bot√≥n de descarga (lo ocultaremos por defecto m√°s arriba)
	document.querySelector('button[onclick="descargarArchivoHTML()"]').style.display = 'inline-block';

	// Mostrar bot√≥n de subir
	document.getElementById('btnSubirGitHub').style.display = 'inline-block';

	// Mostrar bot√≥n el bot√≥n Reemplazar
	document.getElementById('btnReemplazarGitHub').style.display = 'inline-block';

	// Mostrar bot√≥n Crear nueva Tarjeta
       document.getElementById('btnNuevaTarjeta').style.display = 'inline-block';



         document.querySelectorAll('details').forEach(d => d.addEventListener('toggle', function () {
        if (this.open) document.querySelectorAll('details').forEach(o => { if (o !== this) o.removeAttribute('open'); });
      }));
    }





    function copiarHTML() {
      const codigo = document.getElementById('codigoGenerado');
      navigator.clipboard.writeText(codigo.textContent)
        .then(() => alert('‚úÖ C√≥digo copiado'))
        .catch(() => alert('‚ùå Error al copiar'));
    }








// üëá NUEVA FUNCI√ìN ROBUSTA para leer el archivo TXT
// üîí Garantiza que el input existe antes de accederlo
document.addEventListener('DOMContentLoaded', function () {
  const inputArchivo = document.getElementById('archivoTxt');
  if (!inputArchivo) return;

  inputArchivo.addEventListener('change', function(event) {
    const archivo = event.target.files[0];
    if (!archivo) return;

    const lector = new FileReader();

    lector.onload = function(e) {
      const contenido = e.target.result;
      document.getElementById('entradaDatos').value = contenido;

      // ‚úÖ Mostrar el bot√≥n "Generar Tarjeta"
      const btn = document.getElementById('btnGenerar');
      if (btn) btn.style.display = 'inline-block';

      // ‚úÖ Guardar nombre de la tarjeta
      const match = contenido.match(/#NOMTARJETA:\s*\n\s*&ecard:\s*(.+)/i);
      if (match && match[1]) {
        const nombreTarjeta = match[1].trim().replace(/\s+/g, '-').toLowerCase();
        localStorage.setItem('nombreTarjeta', nombreTarjeta);
        console.log('‚úÖ Nombre de tarjeta guardado:', nombreTarjeta);
      } else {
        localStorage.setItem('nombreTarjeta', 'mi-tarjeta');
        console.warn('‚ö†Ô∏è No se encontr√≥ el nombre. Usando "mi-tarjeta".');
      }
    };

    lector.onerror = function() {
      alert('‚ùå No se pudo leer el archivo');
    };

    lector.readAsText(archivo);
  });
});










// üëá NUEVA FUNCI√ìN para descargar el archivo HTML

function descargarArchivoHTML() {
  const contenido = document.getElementById('codigoGenerado').textContent;
  const original = document.getElementById('entradaDatos').value;

  // üîé Intenta extraer el nombre desde el texto original
  let nombreArchivo = 'mi-tarjeta'; // por defecto

const match = original.match(/#NOMTARJETA:\s*&ecard:\s*(.+)/i) ||
              original.match(/#NOMTARJETA:\s*\n\s*&ecard:\s*(.+)/i);

  console.log('üéØ Nombre detectado:', nombreArchivo); // Para verificar en consola

  const blob = new Blob([contenido], { type: 'text/html' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `${nombreArchivo}.html`;
  link.click();

  alert(`‚úÖ Archivo guardado como: ${nombreArchivo}.html`);
}



async function subirAGitHub() {
  const contenido = document.getElementById('codigoGenerado').textContent;
  if (!contenido.trim()) return alert('‚ö†Ô∏è No hay c√≥digo generado para subir.');

  const usuario = localStorage.getItem('Usuario')?.toLowerCase() || 'folio';
  const licMax = parseInt(localStorage.getItem('Lic_Maximas')) || 3;

  try {
    const response = await fetch('https://us-central1-folio-builder-62ea0.cloudfunctions.net/api/subirTarjeta', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        usuario,
        licMax,
        html: contenido
      })
    });

const resultado = await response.json();

if (!response.ok) throw new Error(resultado.error || 'Error desconocido');

await navigator.clipboard.writeText(resultado.url);


alert(`‚úÖ Subido con √©xito
üìÑ Archivo: ${resultado.archivo}
üìä Tarjetas usadas: ${resultado.usadas} / ${parseInt(localStorage.getItem('Lic_Maximas') || 3)}
üîó ${resultado.url} (copiado al portapapeles)`);

window.open(resultado.url, '_blank');


  } catch (err) {
    alert(`‚ùå Error al subir:\n${err.message}`);
    console.error(err);
  }
}



async function consultarFolios() {
  const usuario = localStorage.getItem('Usuario');
  if (!usuario) return alert('‚ö†Ô∏è Usuario no encontrado en sesi√≥n.');

  try {
    const respuesta = await fetch('https://us-central1-folio-builder-62ea0.cloudfunctions.net/api/consultar', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ usuario })
    });

    const data = await respuesta.json();
    if (!respuesta.ok) throw new Error(data.error || 'Error al consultar');

    const contenedor = document.getElementById('listaFoliosConsulta');
    contenedor.innerHTML = '<p style="font-size:0.95rem;">Cargando t√≠tulos...</p>';

    let tabla = `<table style="width:100%; font-size:0.9rem; border-collapse:collapse;">
      <thead>
        <tr style="background:#f0f0f0;">
          <th style="padding:6px;">#</th>
          <th style="padding:6px;">Archivo</th>
          <th style="padding:6px;">T√≠tulo</th>
          <th style="padding:6px;">Descripci√≥n</th>
          <th style="padding:6px;">Enlace</th>
        </tr>
      </thead><tbody>`;

    const resultados = await Promise.all(
      data.map(async (archivo, i) => {
        const url = `https://foliopro.github.io/ecard/${archivo}`;
        try {
          const res = await fetch(url);
          const html = await res.text();
          const titulo = (html.match(/<meta\s+property=["']og:title["']\s+content=["']\s*([\s\S]*?)\s*["']>/i) || [])[1]?.trim() || 'Sin t√≠tulo';
          const descripcion = (html.match(/<meta\s+property=["']og:description["']\s+content=["']\s*([\s\S]*?)\s*["']>/i) || [])[1]?.trim() || 'Sin descripci√≥n';

          return `<tr>
            <td>${i + 1}</td>
            <td>${archivo}</td>
            <td>${titulo}</td>
            <td>${descripcion}</td>
            <td>
              <a href="${url}" target="_blank" style="color:#1976d2;">üåê Ver</a>
              <button onclick="copiarLink('${url}')" style="padding:3px 6px;">üìã Copiar</button>
            </td>
          </tr>`;
        } catch {
          return `<tr>
            <td>${i + 1}</td>
            <td>${archivo}</td>
            <td colspan="3" style="color:red;">‚ùå No se pudo leer</td>
          </tr>`;
        }
      })
    );

    tabla += resultados.join('') + '</tbody></table>';
    contenedor.innerHTML = tabla;
    document.getElementById('modalConsultaFolios').style.display = 'block';

  } catch (e) {
    console.error(e);
    alert('‚ùå No se pudo obtener la lista de archivos.');
  }
}


async function mostrarResumenFolios() {
  const usuario = localStorage.getItem('Usuario');
  if (!usuario) return;

  try {
    const respuesta = await fetch('https://us-central1-folio-builder-62ea0.cloudfunctions.net/api/consultar', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ usuario })
    });

    const data = await respuesta.json();
    if (!respuesta.ok || !Array.isArray(data)) throw new Error('Error al obtener folios');

    const usados = data.length;
    const maximas = parseInt(localStorage.getItem('Lic_Maximas') || '0');

    document.getElementById('infoFolios').innerHTML = `üìä Folios usados: ${usados} / ${maximas}`;
  } catch (e) {
    console.error('‚ùå Error al consultar resumen de folios:', e);
    document.getElementById('infoFolios').textContent = '‚ö†Ô∏è No se pudo cargar resumen de folios.';
  }
}













async function mostrarOpcionesReemplazo() {
  const nombreBase = localStorage.getItem('Usuario');
  if (!nombreBase) return alert('‚ö†Ô∏è No se ha iniciado sesi√≥n correctamente.');

  try {
    const res = await fetch('https://us-central1-folio-builder-62ea0.cloudfunctions.net/api/consultar', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ usuario: nombreBase })
    });

    const archivos = await res.json();
    if (!res.ok || !Array.isArray(archivos)) throw new Error('No se pudieron cargar los archivos');

    if (archivos.length === 0) {
      return alert('‚ö†Ô∏è No se encontraron FolioPro existentes para este usuario.');
    }

    const select = document.getElementById('selectFolio');
    select.innerHTML = archivos.map(nombre => `<option value="${nombre}">${nombre}</option>`).join('');
    document.getElementById('modalReemplazo').style.display = 'block';

  } catch (error) {
    console.error(error);
    alert('‚ùå Error al obtener los archivos desde el servidor');
  }
}



 // Mostrar nombre de usuario arriba a la derecha
  const usuario = localStorage.getItem('Usuario');
  if (usuario) {
    document.getElementById('nombreUsuario').textContent = usuario;
    document.getElementById('bienvenidaUsuario').style.display = 'block';
    mostrarResumenFolios();

  }

  // Funci√≥n para cerrar el modal
  function cerrarModalBienvenida() {
    document.getElementById('modalBienvenida').style.display = 'none';
  }





function cerrarModalReemplazo() {
  document.getElementById('modalReemplazo').style.display = 'none';
}

function confirmarReemplazo() {
  const seleccionado = document.getElementById('selectFolio').value;
  cerrarModalReemplazo();
  reemplazarFolioPro(seleccionado);
}



async function reemplazarFolioPro(nombreArchivo) {
  const contenido = document.getElementById('codigoGenerado').textContent;
  if (!contenido.trim()) return alert('‚ö†Ô∏è No hay contenido para reemplazar.');

  try {
    const response = await fetch('https://us-central1-folio-builder-62ea0.cloudfunctions.net/api/reemplazar', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        nombreArchivo,
        html: contenido
      })
    });

    const data = await response.json();

    if (!response.ok) throw new Error(data.error || 'Error al reemplazar');

    await navigator.clipboard.writeText(data.url);

    alert(`‚úÖ Reemplazado con √©xito\n\nüîó ${data.url} (copiado al portapapeles)`);
    window.open(data.url, '_blank');

  } catch (error) {
    console.error(error);
    alert('‚ùå No se pudo reemplazar el archivo');
  }
}



async function mostrarOpcionesBorrado() {
  const usuario = localStorage.getItem('Usuario');
  if (!usuario) return alert('‚ö†Ô∏è No se ha iniciado sesi√≥n correctamente.');

  try {
    const respuesta = await fetch('https://us-central1-folio-builder-62ea0.cloudfunctions.net/api/opciones-borrado', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ usuario })
    });

    const data = await respuesta.json();

    if (!respuesta.ok) throw new Error(data.error || 'Error al consultar');

    if (!Array.isArray(data.archivos) || data.archivos.length === 0) {
      return alert('‚ö†Ô∏è No hay FolioPro para borrar.');
    }

    const select = document.getElementById('listaFoliosABorrar');
    select.innerHTML = data.archivos.map(nombre => `<option value="${nombre}">${nombre}</option>`).join('');
    document.getElementById('modalBorrar').style.display = 'block';

  } catch (error) {
    console.error(error);
    alert('‚ùå Error al obtener las tarjetas para borrar');
  }
}



function cerrarModalBorrar() {
  document.getElementById('modalBorrar').style.display = 'none';
}



async function borrarFolioPro(nombreArchivo) {
  if (!nombreArchivo) return alert('‚ùå Nombre de archivo no v√°lido');

  try {
    const respuesta = await fetch('https://us-central1-folio-builder-62ea0.cloudfunctions.net/api/borrar', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ archivo: nombreArchivo })
    });

    const resultado = await respuesta.json();

    if (!respuesta.ok) throw new Error(resultado.error || 'Error al eliminar');

    alert(`‚úÖ FolioPro "${nombreArchivo}" fue eliminado exitosamente.`);
  } catch (error) {
    console.error(error);
    alert('‚ùå No se pudo eliminar el archivo');
  }
}



function confirmarBorrado() {
  const seleccionado = document.getElementById('listaFoliosABorrar').value;
  if (!seleccionado) return alert('‚ùå No se seleccion√≥ ning√∫n archivo');

  const ok = confirm(`‚ö†Ô∏è ¬øEst√°s seguro de borrar "${seleccionado}"? Esta acci√≥n no se puede deshacer.`);
  if (!ok) return;

  cerrarModalBorrar();
  borrarFolioPro(seleccionado);
}



// ‚úÖ Mostrar el bot√≥n de Reemplazar (o cualquier otro bot√≥n que necesites)
  document.getElementById('btnBorrarGitHub').style.display = 'inline-block';






function descargarVCF() {
  const nombre = document.querySelector('h2')?.textContent || 'Contacto';
  const descripcion = document.querySelector('.descripcion')?.textContent || '';
  const telMatch = document.querySelector('.ubicacion-line')?.textContent.match(/\+?\d{7,}/);
  const tel = telMatch ? telMatch[0] : '';
  const emailMatch = document.querySelector('.ubicacion-line')?.textContent.match(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/);
  const email = emailMatch ? emailMatch[0] : '';

  const vcf = `BEGIN:VCARD
VERSION:3.0
FN:${nombre}
ORG:${descripcion}
TEL:${tel}
EMAIL:${email}
END:VCARD`;

  const blob = new Blob([vcf], { type: 'text/vcard' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'contacto.vcf';
  link.click();
}


function cerrarSesion() {
  localStorage.removeItem('Usuario');
  localStorage.removeItem('Lic_Maximas');
  alert('üîí Has cerrado sesi√≥n correctamente.');
  window.location.href = 'index.html'; // Redirige al login
}






  </script>


<div class="modal" id="modalImagen" onclick="cerrarDescripcion()" style="display:none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); z-index: 9999; display:none;">
  <div class="modal-contenido" onclick="event.stopPropagation()" style="background:#fff; margin:10% auto; padding:20px; border-radius:10px; max-width:400px; position:relative; text-align:center;">
    <span class="cerrar" onclick="cerrarDescripcion()" style="position:absolute; top:10px; right:20px; cursor:pointer; font-size:1.5rem;">‚ùå</span>
    <div id="descripcionImagen" style="margin-top:20px; font-size:1.1rem;"></div>
  </div>
</div>


<!-- üëá AQUI MODAL PARA LISTA DE TARJETAS-->
<div id="modalReemplazo" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999;">
  <div style="background:#fff; padding:20px; border-radius:8px; max-width:400px; margin:10% auto; text-align:center; position:relative;">
    <h3>üîÅ Selecciona el FolioPro a reemplazar</h3>
    <select id="selectFolio" style="width:90%; padding:10px; margin:10px 0;"></select>
    <div style="margin-top:15px;">
      <button onclick="confirmarReemplazo()" style="padding:10px 16px; background:#007bff; color:#fff; border:none; border-radius:6px;">‚úÖ Reemplazar</button>
      <button onclick="cerrarModalReemplazo()" style="padding:10px 16px; background:gray; color:white; border:none; border-radius:6px; margin-left:10px;">‚ùå Cancelar</button>
    </div>
  </div>
</div>
<!-- üëá FINAL MODAL PARA LISTA DE TARJETAS-->






<!-- üëá AQUI el nuevo modal para documentos -->

  <div class="modal" id="modalDocumento" onclick="cerrarEnlaceExternoModal()" style="display:none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); z-index: 9999;">
    <div class="modal-contenido" onclick="event.stopPropagation()" style="background:#fff; margin:5% auto; padding:20px; border-radius:10px; max-width:90%; max-height:90%; position:relative;">
      <span class="cerrar" onclick="cerrarEnlaceExternoModal()" style="position:absolute; top:10px; right:20px; cursor:pointer; font-size:1.5rem;">‚ùå</span>
      <iframe id="iframeDocumento" src="" style="width:100%; height:80vh; border:none;"></iframe>
    </div>
  </div>




<!-- üóë MODAL DE CONFIRMACION DE BORRADO -->
<div id="modalBorrar" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); z-index: 9999;">
  <div style="background:white; max-width:400px; margin:10% auto; padding:20px; border-radius:10px; position:relative;">
    <h3>üóë Borrar FolioPro</h3>
    <p>Selecciona la tarjeta que deseas borrar:</p>
    <select id="listaFoliosABorrar" style="width:100%; margin:10px 0; padding:6px;"></select>
    <button onclick="confirmarBorrado()" style="background:#c62828; color:white; padding:10px 15px; border:none; border-radius:6px;">Borrar</button>
    <button onclick="cerrarModalBorrar()" style="margin-left:10px;">Cancelar</button>
  </div>
</div>


<!-- Modal para consultar Folios-->
<div id="modalConsultaFolios" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:9999;">
<div style="background:#fff; margin:5% auto; padding:20px; border-radius:10px; max-width:90%; max-height:90vh; overflow:auto; position:relative; padding-bottom:80px;">
    <span onclick="document.getElementById('modalConsultaFolios').style.display='none'" style="position:absolute; top:10px; right:20px; cursor:pointer; font-size:1.5rem;">‚ùå</span>
    <h3>üìÑ Tarjetas de este usuario</h3>
    <div id="listaFoliosConsulta" style="margin-top:15px;"></div>
  </div>
</div>







<script>
  function mostrarDescripcion(texto) {
    const modal = document.getElementById('modalImagen');
    const descBox = document.getElementById('descripcionImagen');
    descBox.innerHTML = decodeURIComponent(texto);
    modal.style.display = 'block';
  }

  function cerrarDescripcion() {
    document.getElementById('modalImagen').style.display = 'none';
  }




    function abrirEnlaceExternoModal(url) {
      try {
        const iframe = document.getElementById('iframeDocumento');
        const modal = document.getElementById('modalDocumento');

        iframe.src = url;
        modal.style.display = 'block';

        setTimeout(() => {
          if (!iframe.contentWindow || iframe.contentDocument.body.innerHTML.trim() === '') {
            window.open(url, '_blank');
            cerrarEnlaceExternoModal();
          }
        }, 3000);
      } catch (e) {
        window.open(url, '_blank');
      }
    }



    function cerrarEnlaceExternoModal() {
      const modal = document.getElementById('modalDocumento');
      const iframe = document.getElementById('iframeDocumento');
      iframe.src = '';
      modal.style.display = 'none';
    }



 window.addEventListener('DOMContentLoaded', () => {
  const usuario = localStorage.getItem('Usuario');
  if (usuario) {
    document.getElementById('nombreUsuario').textContent = usuario;
    document.getElementById('bienvenidaUsuario').style.display = 'block';
const usados = localStorage.getItem('Lic_Usadas') || '0';
const maximas = localStorage.getItem('Lic_Maximas') || '0';
document.getElementById('infoFolios').innerHTML = `üìä Folios usados: ${usados} / ${maximas}`;





    // ‚úÖ Mostrar modal SOLO si no se ha mostrado esta sesi√≥n
    if (!sessionStorage.getItem('BienvenidaMostrada')) {
      mostrarModalBienvenida(); // ü™Ñ Muestra el modal
      sessionStorage.setItem('BienvenidaMostrada', '1'); // üîí Marcar como mostrada
    }
  }
});





function nuevaTarjeta() {
    const ok = confirm("‚ö†Ô∏è ¬øDeseas comenzar una nueva tarjeta? Se perder√°n todos los cambios actuales.");
    if (ok) {
      location.reload();
    }
  }



function descargarQR() {
  const qr = document.getElementById('codigoQRGenerado');
  const link = document.createElement('a');
  link.href = qr.src;
  link.download = 'codigo_qr.png';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}



function cerrarModalBienvenida() {
    document.getElementById('modalBienvenida').style.display = 'none';
  }


function mostrarModalBienvenida() {
  const modal = document.getElementById('modalBienvenida');
  modal.style.display = 'flex';
}


</script>


</body>
</html>



